---
type: mechanic
system: world_systems
tags:
  - proc_gen
  - level_design
  - map
related_files:
  - "[[Lang_RU/10_Mechanics/World/Anomaly_System]]"
---

# Генерация Сектора: Динамическая Топология

> **Цель:** Техническое описание пайплайна генерации, включающее частичное обновление локаций, создание шорткатов (вертикальность) и рендеринг навигационных данных для UI.

---

## 1. Механика «Волатильности» (Partial Reroll)
Мир не меняется полностью каждый день. Сущность ленива. Она меняет только то, что ей наскучило.
При входе в Сектор алгоритм проверяет его **Индекс Волатильности**:

| Тип Изменения | Вероятность | Описание |
| :--- | :--- | :--- |
| **Stable (Стазис)** | 20% | Сектор не меняется. Карта игрока остается открытой. |
| **Glitch (Глитч)** | 40% | **Изменение 10-15%.** Заменяются 1-2 здания (например, *Жилой блок* превратился в *Руины*). Подземелья могут сменить сложность. |
| **Remix (Ремикс)** | 30% | **Изменение 50%.** Сетка дорог остается прежней, но *все* здания перегенерируются. Биом сохраняется. |
| **Wipe (Стирание)** | 10% | **Изменение 100%.** Полная перегенерация ландшафта, смена Биома и Глобальной Аномалии. Карта игрока полностью закрывается "Туманом". |

> **Для Геймдизайна:** Это создает чувство "знакомого, но чужого". Игрок помнит дорогу к площади, но здание на углу уже другое.

---

## 2. Пайплайн Генерации: Слой за Слоем

### Шаг 1: Контейнер и Биом
> **Цель:** Описание алгоритма процедурного заполнения жестко заданных "Контейнеров Секторов" (District Templates).
> **Принцип:** Форма квартала неизменна, содержание — хаотично.

---

## 1. Концепция: Контейнеры Реальности
Мир Элдрейна не является бесконечным полем. Он разбит на дискретные **Сектора-Кварталы**.
* **Статика:** Форма границ сектора, входы/выходы и количество гексов (площадь) заданы заранее вручную.
* **Динамика:** Внутри этих границ Сущность каждый раз "рисует" новый город, используя разные биомы и наборы зданий.

### База Шаблонов (Sector Constraints)
Каждый ID сектора имеет жесткий лимит застройки:

| ID Сектора | Название | Площадь (Гексы) | Форма | Описание |
| :--- | :--- | :--- | :--- | :--- |
| `SEC_01` | **Центральный Перекресток** | **54 hex** | Прямоугольник | Стартовая зона. Широкие улицы, много мелких зданий. |
| `SEC_02` | **Тупик "Аппендикс"** | **36 hex** | Треугольник | Узкая зона для сложных энкаунтеров или босс-арен. |
| `SEC_MAIN_05` | **Промышленный Узел** | **120 hex** | Сложная (Кольцо) | Большой хаб с местом под XL-подземелье. |

---

## 2. Пайплайн Генерации (The Pipeline)

### Шаг 1: Выбор Темы (Biome Injection)
В пустой шаблон (`SEC_01`) заливается "Атмосфера".
* **Вход:** `SEC_01` (54 hexes) + `BIOME_MECH_HIVE` (Механический Улей).
* **Глобальная Аномалия:** Устанавливается автоматически (например, "Вечные Сумерки"). Все тайлы окрашиваются в палитру биома (ржавчина, масло).

### Шаг 2: Расстановка "Якорей" (Anchor POIs)
Сначала ставятся ключевые структуры, которые диктуют геймплей:
1.  **Dungeon Gate:** Вход в подземелье.
2.  **SHELTER (Убежище):**
    * *Описание:* Мини-сейфзона внутри рейда. Бронированная комната с верстаком и костром.
    * *Правило:* 1 гарантированное Убежище на сектора `Size > 40 hex`.
    * *Доступ:* Часто скрыто или требует ключ-карту/взлома.

### Шаг 3: Слой Связности (Shortcuts & Verticality)
После расстановки зданий запускается алгоритм **"Connector"**. Он ищет соседние гексы и создает нетривиальные пути:

* **Rooftop Bridges (Мосты):** Если два здания `Height > 1` стоят рядом, между ними с 40% шансом генерируется доска, труба или мостик.
    * *Цель:* Позволить игроку перемещаться по крышам, избегая патрулей на земле.
* **Breaches (Проломы):** Если стена здания граничит с переулком, в ней может быть сгенерирована "Дыра" (Breach).
    * *Визуал:* Взорванная кладка, закрытая досками (разрушаемый объект).
* **Zip-Lines (Тросы):** От высокого здания (L) к низкому (S) протягивается трос.
* **Sewers (Люки):** Локальные телепорты. Люк на улице A ведет в подвал здания B.

### Шаг 4: Наполнение Зданий
(Генерация интерьеров по Тегам: Больница, Завод, Притон).

---

## 3. Интеграция с UI (Minimap Rendering)
Поскольку карта меняется, статические картинки (PNG) не работают.
Система **HUD_UI** получает "сырые" данные от генератора при загрузке уровня.

### Протокол передачи данных (Map Data Protocol)
Генератор отдает JSON-структуру, которую UI отрисовывает в векторе:

```json
{
  "sector_hash": "AB92-GLITCH-05", // Хэш для проверки "открытости" тумана
  "fog_reset": false, // Если true — карта стирается у игрока
  "grid_overlay": [
    {
      "hex_id": 12,
      "type": "BUILDING",
      "tags": ["HEIGHT_2", "BRIDGE_NORTH"], // UI рисует иконку моста
      "poi_icon": "ICON_SHOP_WEAPON" // Иконка торговца
    },
    {
      "hex_id": 13,
      "type": "OBSTACLE", // Гора мусора
      "traversable": false
    },
    {
      "hex_id": 14,
      "type": "SHELTER",
      "status": "LOCKED" // UI показывает иконку замка
    }
  ]
}